---
layout: post
title: canvas, blob
category: TIL (Today I Learned)
permalink: /til/:year/:month/:day/:title/
tags: [TIL, 학습과정]
comments: true
---

> 최근에 `newJeans` 프로젝트를 하면서 마주친 문제들을 적은 내용입니다.

## 1.

프로젝트에서 canvas로 구현해야할게있어서 react-konva 라이브러리를 사용했는데 구현은 어찌저찌 했지만, 저장이 문제였다.<br/>
내가 꾸민 캔버스를 바로 사용자의 컴퓨터에 저장시켜주는 방법은 어렵지않았으나, 내가 하고자하는건 저장버튼을 누르면 캔버스를 이미지화시켜서 사용자 컴퓨터가 아닌, 서버에 바로 저장시키는거였는데 이부분에서 좀 애를먹었다. (나중에 aws s3에 저장시켜줄거였음)<br/>
결론부터 말하자면, 나는 사용자의 컴퓨터에 저장시키고 사용자가 파일을 다시 올리는 방법을 선택하게되었다.<br/>

## 2.

사용자의 컴퓨터에 캔버스 이미지를 저장시키고 사용자가 그 이미지를 업로드 시키는식으로 구현 방향을 틀었지만, 사용자가 작성한 캔버스를 이미지화시켜서 서버에 바로 올리는 방식으로 하기위해서 시도했던것들을 적어보려고한다. <br/><br/>

react-konva가 캔버스를 이미지화시켜주는데 제시한것은 toDataurl()와 toImageUrl(),그리고 간단한건 JSON으로 변환시켜주는 toJSON() 이 세가지를 제시하였다.<br/>
toJSON()은 말그대로 JSON화 시켜줬다. 근데 캔버스에 그려지는게 많고 복잡해질수록 JSON이 길어질테고, JSON 자체를 서버에 저장시켜주게되면 서버 용량을 너무 차지하게 될거같아서 패스.<br/>

toDataUrl()와 toImageUrl()은 캔버스를 base64문자열로 만들어줬는데 이게 어마어마하게 길었다. 그래서 blob객체로 만들어준후 fileData에 담아서 서버 multer를 통해 로컬 uploads폴더에 파일이 들어가고 프론트에서 img src에 넣어서 이미지가 로드되는것까진 확인했다.<br/>

근데 uploads폴더에 예를들면 234234234-blob 라고 저장되었고, `이미지 확장자 .jpg나.png같은게 안붙은채로 저장`이되었다.<br/>
어차피 이미지 로드는 잘되니, 나중에 aws s3에 넣고 쓰는데 문제는 없을것같았는데 영 찜찜해서 초반에 말했던 사용자가 캔버스이미지를 컴퓨터에 저장시키고 다시 업로드시키는식으로 노선을 바꿨다.

## 3.

2번에서 말한 이미지 확장자가 안붙은채로 저장되는 문제는 blob객체로 만들어진것의 type을 확인해서 추출하면 됬을것같다. type은 image/jpeg,image/png 이런식으로 전달됬었는데, split해서 뒷부분만 잘라서 붙인다음 서버 multer에 전달했으면 해결됬을것같긴하다.<br/><br/>

혹은 .. blob객체로까지 만들어줄 필요는없을것 같고,toDataurl,toImageUrl을사용해서 urlencode한 base64 형태로 서버에 전달해서, 서버에서 디코딩 처리후 바이너리로 저장하는 경우를 사용해도 됬을것같다. base64가 문자열 형태라서 가능한 방법이였는데.. 뭐 이미 노선을 바꿨으니 다음 프로젝트에서 image를 이와 비슷하게 처리해줘야할 일이 생기면 한번 시도해봄직할것같다.
